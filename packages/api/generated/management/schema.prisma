generator client {
  provider = "prisma-client-js"
  output   = "../generated/management"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id                  String                @id @default(cuid())
  name                String
  subdomain           String                @unique
  customDomain        String?               @unique
  dbSchema            String                @unique
  status              TenantStatus          @default(PENDING)
  suspendedAt         DateTime?
  deletedAt           DateTime?
  ownerId             String
  planId              String?
  settings            Json?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  stripeCustomerId    String?               @unique
  paymentIndices      PaymentIndex[]
  SubscriptionPayment SubscriptionPayment[]
  subscription        TenantSubscription?
  owner               User                  @relation(fields: [ownerId], references: [id])
  plan                SubscriptionPlan?     @relation(fields: [planId], references: [id])

  @@index([ownerId])
  @@index([planId])
  @@index([status])
  @@map("tenants")
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  hashedPassword String
  firstName      String?
  lastName       String?
  role           UserRole @default(TENANT_OWNER)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  ownedTenant    Tenant[]

  @@map("users")
}

model SubscriptionPlan {
  id             String               @id @default(cuid())
  name           String
  price          Decimal              @db.Decimal(10, 2)
  billingCycle   BillingCycle
  features       Json
  createdAt      DateTime             @default(now())
  providerPlanId String?              @unique
  subscriptions  TenantSubscription[]
  tenants        Tenant[]

  @@map("subscription_plans")
}

model TenantSubscription {
  id                     String                @id @default(cuid())
  tenantId               String                @unique
  planId                 String
  status                 SubscriptionStatus    @default(ACTIVE)
  provider               String                @default("STRIPE")
  providerSubscriptionId String?
  currentPeriodStart     DateTime
  currentPeriodEnd       DateTime
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  SubscriptionPayment    SubscriptionPayment[]
  plan                   SubscriptionPlan      @relation(fields: [planId], references: [id])
  tenant                 Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([provider, providerSubscriptionId])
  @@map("tenant_subscriptions")
}

model SubscriptionPayment {
  id                    String             @id @default(cuid())
  tenantId              String
  amount                Decimal            @db.Decimal(10, 2)
  currency              String
  status                String
  provider              String
  providerTransactionId String
  subscriptionId        String
  createdAt             DateTime           @default(now())
  subscription          TenantSubscription @relation(fields: [subscriptionId], references: [id])
  tenant                Tenant             @relation(fields: [tenantId], references: [id])

  @@unique([provider, providerTransactionId])
  @@index([tenantId])
  @@map("subscription_payments")
}

model PaymentIndex {
  id                String   @id @default(cuid())
  tenantId          String
  orderId           String
  checkoutRequestId String   @unique
  createdAt         DateTime @default(now())
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("payment_indices")
}

enum TenantStatus {
  PENDING
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  UNPAID
}

enum UserRole {
  PLATFORM_ADMIN
  PLATFORM_SUPPORT
  TENANT_OWNER
}
