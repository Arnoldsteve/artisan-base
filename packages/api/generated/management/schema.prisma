// =================================================================
// ||                COMPLETE MANAGEMENT SCHEMA                   ||
// =================================================================

generator client {
  provider = "prisma-client-js"
  output   = "../generated/management"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Represents the tenant (a single store)
model Tenant {
  id             String              @id @default(cuid())
  name           String
  subdomain      String              @unique
  customDomain   String?             @unique
  dbSchema       String              @unique
  status         TenantStatus        @default(PENDING)
  suspendedAt    DateTime?
  deletedAt      DateTime?
  owner          User                @relation(fields: [ownerId], references: [id])
  ownerId        String
  plan           SubscriptionPlan?   @relation(fields: [planId], references: [id])
  planId         String?
  subscription   TenantSubscription?
  settings       Json?
  paymentIndices PaymentIndex[]
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  @@index([ownerId])
  @@index([planId])
  @@index([status])
  @@map("tenants")
}

// Represents a user of the SAAS PLATFORM itself, not a tenant's customer.
model User {
  id             String   @id @default(cuid())
  email          String   @unique
  hashedPassword String
  firstName      String?
  lastName       String?
  role           UserRole @default(TENANT_OWNER) // Platform-level roles

  // The tenant that this user owns (if any).
  ownedTenant Tenant[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

// Defines the available subscription plans you offer (e.g., Basic, Pro).
model SubscriptionPlan {
  id           String       @id @default(cuid())
  name         String // "Basic", "Pro", "Enterprise"
  price        Decimal      @db.Decimal(10, 2)
  billingCycle BillingCycle

  // A JSONB field to control features and limits.
  features Json

  tenants       Tenant[]
  subscriptions TenantSubscription[]

  createdAt DateTime @default(now())

  @@map("subscription_plans")
}

// Represents a tenant's active subscription instance.
model TenantSubscription {
  id                     String             @id @default(cuid())
  tenantId               String             @unique
  tenant                 Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  planId                 String
  plan                   SubscriptionPlan   @relation(fields: [planId], references: [id])
  status                 SubscriptionStatus @default(ACTIVE)
  provider               String             @default("STRIPE")
  providerSubscriptionId String?

  // Timestamps managed by the payment provider (e.g., Stripe)
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime

  // Legacy Stripe field (keep for backward compatibility)
  stripeSubscriptionId String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, providerSubscriptionId])
  @@map("tenant_subscriptions")
}

model PaymentIndex {
  id                String   @id @default(cuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orderId           String // The ID of the order within the tenant's schema
  checkoutRequestId String   @unique // The temporary ID from the payment provider
  createdAt         DateTime @default(now())

  @@index([tenantId])
  @@map("payment_indices")
}

// --- Enums ---
enum TenantStatus {
  PENDING
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  UNPAID
}

enum UserRole {
  PLATFORM_ADMIN // Full platform access
  PLATFORM_SUPPORT // Customer support access
  TENANT_OWNER // Owns tenant stores
}

// REMOVED: PaymentProvider enum (exists in tenant.prisma)
