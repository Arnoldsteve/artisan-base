// =================================================================
// ||                COMPLETE MANAGEMENT SCHEMA                   ||
// =================================================================

generator client {
  provider = "prisma-client-js"
  output   = "../generated/management"
}

datasource db {
  provider = "postgresql"
  url      = env("MANAGEMENT_DATABASE_URL")
}

// Represents the tenant (a single store) - FIXED FOR SEPARATE DBS
model Tenant {
  id           String  @id @default(cuid())
  name         String // The human-friendly store name, e.g., "Malaika Beads"
  subdomain    String  @unique // The unique subdomain for routing, e.g., "malaikabeads"
  customDomain String? @unique // Optional custom domain for pro plans

  // SEPARATE DATABASE FIELDS (replaces dbSchema)
  databaseUrl       String? @unique // Full Supabase connection string
  supabaseProjectId String? @unique // Supabase project reference

  status TenantStatus @default(PENDING)

  // Audit fields for better tracking
  suspendedAt DateTime?
  deletedAt   DateTime? // Soft delete support

  // A tenant must be owned by one user.
  owner   User   @relation(fields: [ownerId], references: [id])
  ownerId String

  // The subscription plan the tenant is on.
  plan   SubscriptionPlan? @relation(fields: [planId], references: [id])
  planId String?

  // The live subscription details from the payment provider.
  subscription TenantSubscription?

  // A JSONB field for tenant-wide settings that don't need a full table.
  // e.g., { "logoUrl": "...", "themeColor": "#ff0000" }
  settings Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Performance indexes
  @@index([ownerId])
  @@index([planId])
  @@index([status])
  @@map("tenants")
}

// Represents a user of the SAAS PLATFORM itself, not a tenant's customer.
model User {
  id             String   @id @default(cuid())
  email          String   @unique
  hashedPassword String
  firstName      String?
  lastName       String?
  role           UserRole @default(TENANT_OWNER) // Platform-level roles

  // The tenant that this user owns (if any).
  ownedTenant Tenant[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

// Defines the available subscription plans you offer (e.g., Basic, Pro).
model SubscriptionPlan {
  id           String       @id @default(cuid())
  name         String // "Basic", "Pro", "Enterprise"
  price        Decimal      @db.Decimal(10, 2)
  billingCycle BillingCycle

  // A JSONB field to control features and limits.
  features Json

  tenants       Tenant[]
  subscriptions TenantSubscription[]

  createdAt DateTime @default(now())

  @@map("subscription_plans")
}

// Represents a tenant's active subscription instance.
model TenantSubscription {
  id       String             @id @default(cuid())
  tenantId String             @unique
  tenant   Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  planId   String
  plan     SubscriptionPlan   @relation(fields: [planId], references: [id])
  status   SubscriptionStatus @default(ACTIVE)

  // Multi-provider support (using String instead of enum to avoid duplicates)
  provider               String  @default("STRIPE") // "STRIPE", "PAYPAL", "MPESA", etc.
  providerSubscriptionId String?

  // Timestamps managed by the payment provider (e.g., Stripe)
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime

  // Legacy Stripe field (keep for backward compatibility)
  stripeSubscriptionId String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, providerSubscriptionId])
  @@map("tenant_subscriptions")
}

// --- Enums ---
enum TenantStatus {
  PENDING
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  UNPAID
}

enum UserRole {
  PLATFORM_ADMIN // Full platform access
  PLATFORM_SUPPORT // Customer support access
  TENANT_OWNER // Owns tenant stores
}

// REMOVED: PaymentProvider enum (exists in tenant.prisma)
